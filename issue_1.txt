--.RUN FILE = 'D:\HQA_BTEQ\CONNECTION\UMKTNTLHQA.txt';


---------------------XXXXXXXXXXXXXXXXXXXXXXXX---------------------   START OF  CONSUMER_OUTLET_DATE_TYPE_TRACKER   LOAD   ---------------------XXXXXXXXXXXXXXXXXXXXXXXX---------------------   



SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;



/*===================================================================================================================================================================================================


Clears out all values that need ot be restated.  


===================================================================================================================================================================================================*/ 
SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;



 
/*===================================================================================================================================================================================================


Set current values from Outlet V


===================================================================================================================================================================================================*/ 
 
SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;


/*===================================================================================================================================================================================================


Sets values from the first VLM record based on sls_outlet_Id


===================================================================================================================================================================================================*/ 
SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;

    
	
/*===================================================================================================================================================================================================


Sets values from the Last VLM record based on sls_outlet_Id


===================================================================================================================================================================================================*/ 
	
SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;
  /*===================================================================================================================================================================================================


Sets values from the VLM record based on sls_outlet_Id and VLM Code


===================================================================================================================================================================================================*/ 
	
SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;

 
 /*===================================================================================================================================================================================================


Creates an Open/Close date for non VLM records from the first and last active records in outlet_hist_v for indirect


===================================================================================================================================================================================================*/ 
 

SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;

 ---------------------XXXXXXXXXXXX--------------------- Sets Assume close date = open date when close date was earlier than open  ---------------------XXXXXXXXXXXX---------------------

/*

UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER 

SET ASSUME_CLOSE_DT = ASSUME_OPEN_DT 
WHERE ASSUME_CLOSE_DT < ASSUME_OPEN_DT 

 */
 
 
 /*===================================================================================================================================================================================================


 Retail Stores that at some time were taged as closed which changed the open date to a later date than it should be  
 

===================================================================================================================================================================================================*/ 
 
SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;

 /*===================================================================================================================================================================================================


Select list of Retail stores that had an incorrect close date assigned to them  
 

===================================================================================================================================================================================================*/ 
 
SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;

 /*===================================================================================================================================================================================================

Tags Event Doors

===================================================================================================================================================================================================*/ 


SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;



 /*===================================================================================================================================================================================================


Sets Executive door cnt and executive door cnt with prepay to Y for all non event retail doors
 

===================================================================================================================================================================================================*/ 
 

SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;




 /*===================================================================================================================================================================================================


Cleans up bad retial record that has excl indirect ind.


===================================================================================================================================================================================================*/ 
 

SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;





 /*===================================================================================================================================================================================================


Sets door count indicators for non VLM Local/Big 6 Records


===================================================================================================================================================================================================*/ 
 
SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;



 /*===================================================================================================================================================================================================


Sets door count indicators for non VLM National Retail Records


===================================================================================================================================================================================================*/ 
SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;


 /*===================================================================================================================================================================================================


Sets door count indicators for  VLM records


===================================================================================================================================================================================================*/ 
SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;



 /*===================================================================================================================================================================================================


Set Military records to on based on MASTER_AGENT_ID = 'osl'  Per Request from Susan Buckles around end of Jan 2025


===================================================================================================================================================================================================*/ 
SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;

 



 /*===================================================================================================================================================================================================


Sets door count indicators for  VLM prepay records


===================================================================================================================================================================================================*/ 


SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;


 /*===================================================================================================================================================================================================


Sets EXECUTIVE_DOOR_CNT_W_PREPAY_IND based on other indicators


===================================================================================================================================================================================================*/ 

SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;

 /*===================================================================================================================================================================================================


Turns off all indicators based on future doros, event doors, and known bad list of outlets


===================================================================================================================================================================================================*/ 


SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;



 /*===================================================================================================================================================================================================


Turns off all indicators based for new Post-Sale support doors


===================================================================================================================================================================================================*/ 


 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;



 /*===================================================================================================================================================================================================


Loads offical open/close dates using manual column first, then earliest open (7-31) then vlm, then outlet_v


===================================================================================================================================================================================================*/ 


 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;



 /*===================================================================================================================================================================================================


provides open/close date for any records without open date.  To keep from searching and nulls throwing off querry


===================================================================================================================================================================================================*/ 

 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;



 /*===================================================================================================================================================================================================


UPSERT New/Updated Divest Records

-------------------- Danny will need to take the SKIP_DIVEST section loading from SSIS if this remains.  We need to see if this still used and if it needs those tables.  May be directly available in VLM

===================================================================================================================================================================================================*/ 


 /*===================================================================================================================================================================================================


Deletes the old Divest Tracking Records that were removed from the Tracker Sheet


===================================================================================================================================================================================================*/ 


 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;




/*-------------------------------------************************************-------------------------------------************************************-------------------------------------************************************-------------------------------------

-------------------------------------------------------------------------------------------------------                                                             Main Insert Section                                                                   -----------------------------------------------------------------------------------------------------

-------------------------------------************************************-------------------------------------************************************-------------------------------------************************************-------------------------------------*/


/*-------------------------------------************************************-------------------------------------************************************-------------------------------------************************************-------------------------------------

-------------------------------------------------------------------------------------------------------                                                             Misc Section                                                                   -----------------------------------------------------------------------------------------------------

-------------------------------------************************************-------------------------------------************************************-------------------------------------************************************-------------------------------------*/



 /*===================================================================================================================================================================================================

Clears records taht will be updated

===================================================================================================================================================================================================*/ 
 
 
 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;

 
 /*===================================================================================================================================================================================================

Set Current Month IND

===================================================================================================================================================================================================*/ 

 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;


 /*===================================================================================================================================================================================================

Set Current Open IND

===================================================================================================================================================================================================*/ 


 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;

 /*===================================================================================================================================================================================================
 
 Indirect door type
 
===================================================================================================================================================================================================*/ 

 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;


 /*===================================================================================================================================================================================================
 
Retail door type
 
===================================================================================================================================================================================================*/ 



/*-------------------------------------************************************-------------------------------------************************************-------------------------------------************************************-------------------------------------

-------------------------------------------------------------------------------------------------------                                                                      GEO Section                                                                   -----------------------------------------------------------------------------------------------------

-------------------------------------************************************-------------------------------------************************************-------------------------------------************************************-------------------------------------*/



 /*===================================================================================================================================================================================================

Update Lat/Long on recent recrods from VLM.  Will do more records in future.  
HQA_PRD_QMTBLS.CONSUMER_OUTLET_LAT_LONG_FIX_PROXY being used until VLM batch is done.

===================================================================================================================================================================================================*/ 

 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;

 /*===================================================================================================================================================================================================

Updates Lat/Long to current one for old ones with same outlet/addr_line1.  Need to incorporate USPS scrub in future

===================================================================================================================================================================================================*/ 


 /*===================================================================================================================================================================================================

Scrub bad records that are out of bounds (Lat not between -90 and 90, or Long not between -180 and 180
Step below identifies likely instances where lat/long were swapped in source data

===================================================================================================================================================================================================*/ 

 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;



 /*===================================================================================================================================================================================================

Scrub bad records that are out of bounds (Lat not between -90 and 90, or Long not between -180 and 180
Step below identifies likely instances where lat/long were swapped in source and the longitude was not negative

===================================================================================================================================================================================================*/ 




 /*===================================================================================================================================================================================================

Scrub bad records that are out of bounds (Lat not between -90 and 90, or Long not between -180 and 180
Step below clears out remainder that are out of bounds.

===================================================================================================================================================================================================*/ 



/*============================================================================================================================================================================================================

Set using SQL Server based geo-mapping

============================================================================================================================================================================================================*/
 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;




/*============================================================================================================================================================================================================

Set based on EDW Zipcode based for null values in sql server (usually bad lat/long)

============================================================================================================================================================================================================*/


/*============================================================================================================================================================================================================

Update CMA_XREF and DMA_XREF tables for changes in TIER info
Maybe change name later?

============================================================================================================================================================================================================*/
 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;






/*============================================================================================================================================================================================================

Set CMA name and tier off of key

============================================================================================================================================================================================================*/


/*============================================================================================================================================================================================================

Set DMA name and tier off of Key

============================================================================================================================================================================================================*/

 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;


/*============================================================================================================================================================================================================

Set density class off of zip (if sql server did not map)

============================================================================================================================================================================================================*/


 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;



/*-------------------------------------************************************-------------------------------------************************************-------------------------------------************************************-------------------------------------

-------------------------------------------------------------------------------------------------------                                                             Hierarchy Section                                                                   -----------------------------------------------------------------------------------------------------

-------------------------------------************************************-------------------------------------************************************-------------------------------------************************************-------------------------------------*/


 /*===================================================================================================================================================================================================

Defines ZREF for Pre April 1 2019 records

===================================================================================================================================================================================================*/ 


 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;

 /*===================================================================================================================================================================================================

Updates records based on CONSUMER_HIERARCHY_HIST_V

===================================================================================================================================================================================================*/ 
 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;



/*-------------------------------------************************************-------------------------------------************************************-------------------------------------************************************-------------------------------------

-------------------------------------------------------------------------------------------------------                                                            VLM/SLDB Section                                                                   -----------------------------------------------------------------------------------------------------

-------------------------------------************************************-------------------------------------************************************-------------------------------------************************************-------------------------------------*/


 /*===================================================================================================================================================================================================

VLM data/info

===================================================================================================================================================================================================*/ 

 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;


 /*===================================================================================================================================================================================================

From SLDB.  Set old building_type and Location_type fields to VLM if available if not use old SLDB Extract. Removed 8/23/2023.

===================================================================================================================================================================================================*/ 


SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;

 
 

 /*===================================================================================================================================================================================================

VLM info for Retail null values

===================================================================================================================================================================================================*/ 


 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;



/*-------------------------------------************************************-------------------------------------************************************-------------------------------------************************************-------------------------------------

-------------------------------------------------------------------------------------------------------                                                           Outlet Tracker Section                                                                   -----------------------------------------------------------------------------------------------------

-------------------------------------************************************-------------------------------------************************************-------------------------------------************************************-------------------------------------*/


 /*===================================================================================================================================================================================================

Set all tags from CONSUMER_OUTLET_DATE_TYPE_TRACKER table

===================================================================================================================================================================================================*/ 
SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;


 /*===================================================================================================================================================================================================

Defines Channel info   

===================================================================================================================================================================================================*/ 

SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;



/*-------------------------------------************************************-------------------------------------************************************-------------------------------------************************************-------------------------------------

------------------------------------------------------------------------------------------------------- Divest/Acquire Section -----------------------------------------------------------------------------------------------------

-------------------------------------************************************-------------------------------------************************************-------------------------------------************************************-------------------------------------*/


 /*===================================================================================================================================================================================================

Populate CHANGE_FROM_MULTI_SLS_OUTLET_ID

===================================================================================================================================================================================================*/ 
SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;


 /*===================================================================================================================================================================================================

 Populate Change To Fields
 
===================================================================================================================================================================================================*/ 

 /*===================================================================================================================================================================================================

 Populate Change From Fields
 
===================================================================================================================================================================================================*/ 
 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;


 /*===================================================================================================================================================================================================

Physical Location OPEN_DT

===================================================================================================================================================================================================*/ 
SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;



 /*===================================================================================================================================================================================================

Physical Location CLOSE_DT

===================================================================================================================================================================================================*/ 

 /*===================================================================================================================================================================================================

DIVEST_FROM

===================================================================================================================================================================================================*/ 


 /*===================================================================================================================================================================================================

DIVEST_TO

===================================================================================================================================================================================================*/ 




/*-------------------------------------************************************-------------------------------------************************************-------------------------------------************************************-------------------------------------

-------------------------------------------------------------------------------------------------------                                                      Master Agent Section                                                                   -----------------------------------------------------------------------------------------------------

-------------------------------------************************************-------------------------------------************************************-------------------------------------************************************-------------------------------------*/


 /*===================================================================================================================================================================================================

AGENT_TO_AGENT_ACQUIRE_MTH_CNT Change CNT for MAID only Change

===================================================================================================================================================================================================*/ 



 /*===================================================================================================================================================================================================

AGENT_TO_AGENT_ACQUIRE_MTH_CNT Change CNT For Code Change


===================================================================================================================================================================================================*/ 

 UPDATE HQA_PRD_QMTBLS.CONSUMER_OUTLET_DATE_TYPE_TRACKER
 
 SET VLM_OPEN_DT = NULL
 ,VLM_CLOSE_DT = NULL
 ,OUTLET_V_OPEN_DT = NULL
 ,OUTLET_V_CLOSE_DT = NULL
 ,OUTLET_HIST_EARLIEST_OPEN_DT = NULL
 ,OUTLET_HIST_LATEST_CLOSE_DT = NULL
 ,OFFICIAL_OPEN_DT = NULL
 ,OFFICIAL_CLOSE_DT = NULL
 ,EVENT_DOOR_IND = 'N'
 ,EXECUTIVE_DOOR_CNT_IND  = 'N'
 ,EXECUTIVE_DOOR_CNT_W_PREPAY_IND  = 'N'
 ,PREPAY_DOOR_CNT_IND  = 'N'
 ,VLM_LOCATION_TYPE = NULL
 ,VLM_BUILDING_TYPE = NULL
 ,VALID_VLM_RECORD_IND = 'N'
 ,CHANNEL_TYPE  = NULL 
 ,EXCL_INDIRECT_IND = NULL
 ,EXCL_INDIRECT_CTGRY = NULL
 ,ZREF_ID = NULL
 ,VLM_STATUS = 'N/A'
 ,OUTLET_V_STATUS = 'N/A'
 ;




 /*===================================================================================================================================================================================================

Defines Master Agent DESC info   

===================================================================================================================================================================================================*/ 

SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;


 /*===================================================================================================================================================================================================

Current Master Agent.  Other master Agent ID fields are as of EOM

===================================================================================================================================================================================================*/ 


 /*===================================================================================================================================================================================================

BOM Master Agent

===================================================================================================================================================================================================*/ 


 SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;

 /*===================================================================================================================================================================================================

MASTER_AGENT_CHANGE_MTH_CNT

===================================================================================================================================================================================================*/ 



 /*===================================================================================================================================================================================================

Prev Master Agent based on if the EOM previous month  master agent is differnt than the current EOM master Agent

===================================================================================================================================================================================================*/ 


 /*===================================================================================================================================================================================================

Prev Master Agent based on previous sls_outlet_id (change_From_sls_outlet_id) if there is one.  It also will only update if the previous query left nulls.  This is to prevent it from overwriting if after the change from a 
differnt sls_outlet_id that there was an agent to agent change

===================================================================================================================================================================================================*/ 




/*-------------------------------------************************************-------------------------------------************************************-------------------------------------************************************-------------------------------------

-------------------------------------------------------------------------------------------------------                                                           Door Counts Section                                                                   -----------------------------------------------------------------------------------------------------

-------------------------------------************************************-------------------------------------************************************-------------------------------------************************************-------------------------------------*/

 /*===================================================================================================================================================================================================

Sets count fields for aggregated sum of data

===================================================================================================================================================================================================*/ 





 /*===================================================================================================================================================================================================

Sets prodicitvy door counts

===================================================================================================================================================================================================*/ 




 /*===================================================================================================================================================================================================

Turns on counted door ind field based on when the dor was counted at beginning or end of month  for filtering.

===================================================================================================================================================================================================*/ 

SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;


 /*===================================================================================================================================================================================================
 
Prior year door count
 
===================================================================================================================================================================================================*/ 


 /*===================================================================================================================================================================================================

Status change field.  This needs edits

===================================================================================================================================================================================================*/ 

SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;





 /*===================================================================================================================================================================================================

Month Open/CLOSE CNT and DIVEST RTL TO IND CNT

===================================================================================================================================================================================================*/ 



 /*===================================================================================================================================================================================================

Status change ADJ  field.  This needs edits

===================================================================================================================================================================================================*/ 

SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;


 /*===================================================================================================================================================================================================

Replace empty fields ('') with  (' ').  Due to microsoft stupid eror (deliberately misspelled) with their Teradata 1.0 Connector.

===================================================================================================================================================================================================*/ 





----------FIX INVISIBLE CHARACTERS IN SALES_LEAD_APP FIELD 073121-------------------------------------------------------------------------


 /*===================================================================================================================================================================================================

Update Home Internet Field

===================================================================================================================================================================================================*/ 
SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;



/*===================================================================================================================================================================================================
 
Move data to HQA_PRD_QMTBLS.HQA_CONSUMER_OUTLET_HIST
 
===================================================================================================================================================================================================*/ 



 /*===================================================================================================================================================================================================
 
Move data to NTL_PRDUSR_TBLS.HQA_CONSUMER_OUTLET_HIST
 
===================================================================================================================================================================================================*/ 

SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;


 /*===================================================================================================================================================================================================
 
Combined all door count table load
 
===================================================================================================================================================================================================*/ 




-------------------- Not sure if this is used.  Potential to be removed  9/25/2024
 


 /*===================================================================================================================================================================================================
 
Competitor data for compiled count table

===================================================================================================================================================================================================*/ 
-------------------- Not sure if this is used.  Potential to be removed  9/25/2024


 /*===================================================================================================================================================================================================
 
Sort order for table 
 
===================================================================================================================================================================================================*/ 

SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;
-------------------- Not sure if this is used.  Potential to be removed  9/25/2024


----- Hours Table Draft

------  Below hours tables removed on 11/22/21 as it has been supersceded by NTL_PRD_ALLVM.STORE_HOURS_V and NTL_PRD_QMVM.STORE_HOURS_V (jeremey deane version with extra columns and historical data added in)


SELECT 

Td_Month_Begin(CALENDAR_DATE) AS RPT_MTH
,CASE WHEN Td_Month_Begin(CALENDAR_DATE) = Td_Month_Begin(DATE) THEN DATE ELSE Td_Month_End(CALENDAR_DATE) END AS RPT_EOM

FROM SYS_CALENDAR.CALENDAR

WHERE CALENDAR_DATE BETWEEN  Add_Months(Td_Month_Begin(DATE-1),-1)  AND DATE
--WHERE CALENDAR_DATE BETWEEN  1130101  AND DATE

GROUP BY 1,2;


-----------------------------------------------------------
.LABEL  SKIP_ALL

------------------------------------------------------------


-- PLACEHOLDER FOR VB SCRIPT TO PULL LOAD QTY FROM LOG FILE


 

