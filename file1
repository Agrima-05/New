MERGE INTO udm_prd_tbls.IVR_CALL U 
USING  ( SELECT PCID 
,GCID                          
,CPS                          
,COALESCE(MXDH.SOR_ID, X.SOR_ID) SOR_ID
,COALESCE(MXDH.CUST_ID, X.CUST_ID) CUST_ID
,COALESCE(MXDH.CUST_LINE_SEQ_ID, X.CUST_LINE_SEQ_ID)
CUST_LINE_SEQ_ID
,LINE                        
,DURATION                   
,STEPS                     
,LANG_PREF_IND            
,DNIS                    
,ANI                    
,ADFLAG                
,ANIFLAG              
,FINALRESULT         
,INITTYPE           
,CALLDATE          
,CALLTIME         
,REGISTERED      
,TPOINT         
,SELFHELP      
,FNTOTAL      
,FNBALANCE   
,FNMINUTES  
,FNPAYMENTS
,FNFEATURES                    
,FNTUTORIALS                  
,LASTMTN                     
,PREPAID                    
,WHOLESALE                 
,ASL                      
,FIRSTBILL               
,COLLECTIONS            
,CHURN                 
,SEGMENTATION         
,NPA                 
,BSC                
,JIC2              
,FNSTORE          
,FNPAYLOC        
,FNACH          
,FNJIC1        
,FNJIC2       
,JIC1        
,CACS       
,NATL_ACCT_TYPE                
,FIRST_BILL                   
,IVR_VALUE                   
,PORT_IN                    
,PROMPT_SELECTED           
,AMOUNT_PAID              
,PAYMENT_METHOD          
,ROUTE_VALUE            
,CALLPATH              
,CACS_STATE           
,ROUTE_ID            
,ESNMEID_ORIG       
,ESNMEID_NEW       
,PREPAY_COSP      
,PREPAY_STATUS   
,REVISED_ROLE   
,SELFHELPSTART 
,ONEBILL_FLAG 
,DEVICE_ID   
,SOR_NM     
,ERR_MSG   
,USR_ORIG_DN     
,SALES_CHANNEL  
,EMP_ID        
,ESC_LOC_CD   
,CMR_FLAG    
,INBOUND_CALL_TYPE     
,DEV_TYPE_ORG         
,DEV_TYPE_NEW        
,KPI_SELFHELP_RULE  
,KPI_SELFHELPSTART_RULE 
,IMEI_ORIG
,IMEI_NEW 
,NOTIFICATION_ID
,CBR_NUMBER 
,US_TYPE_PROD_ID
,US_LOB
,ROUTE_SELECT_VALUE 
,LOB
,C2C_EMPLOYEE_ID
FROM udm_prdstg_tbls.IVR_CALL
LEFT
OUTER
JOIN udm_prd_tbls.mtn_xref_dly_hist MXDH
ON LASTMTN  = MXDH.MTN
AND MXDH.SOR_ID = 'V'
AND CALLDATE BETWEEN MXDH.EFF_DT AND MXDH.EXP_DT
LEFT
OUTER
JOIN udm_prd_itvm.MTN_XREF X   
ON LASTMTN  = X.MTN
AND X.SOR_ID = 'V'
QUALIFY ROW_NUMBER()OVER(PARTITION BY PCID,DNIS,COALESCE(LASTMTN,'MTN') ORDER BY CALLDATE DESC)=1
) S
ON U.IVR_CALL_ID      		= S.PCID   
AND U.DNIS_CD          		= S.DNIS
AND COALESCE(U.MTN,'MTN')   	= COALESCE(S.LASTMTN,'MTN')
AND U.IVR_CALL_DT     	    = S.CALLDATE    
-- AND S.LASTMTN IS NOT NULL
 
WHEN MATCHED 

THEN UPDATE
SET SOR_ID                         = S.SOR_ID
,CUST_ID                        = S.CUST_ID
,CUST_LINE_SEQ_ID               = S.CUST_LINE_SEQ_ID
,CPS_ID                         = S.CPS
,IVR_LINE_ID                    = S.LINE
,IVR_CALL_SOU                   = S.DURATION
,IVR_STEPS                      = S.STEPS
,LANG_PREF_IND                  = S.LANG_PREF_IND
,ANI_NUM                        = S.ANI
,AD_CD                          = S.ADFLAG
,ANI_INSTANCE_IND               = S.ANIFLAG
,IVR_FINAL_RESULT               = S.FINALRESULT
,INIT_TYPE_CD                   = S.INITTYPE
--        ,IVR_CALL_DT                    = S.CALLDATE
,IVR_CALL_TM                    = S.CALLTIME
,RGSTR_GEOTEL_IND               = S.REGISTERED
,TRANSFER_POINT                 = S.TPOINT
,SELFHELP                       = S.SELFHELP
,PREPAID_IND                    = S.PREPAID
,NPA_NUM                        = S.NPA
,BSC                            = S.BSC    
,COAST_IND                      = S.JIC1
,FINAL_CACS_VALUE               = S.CACS
,NATL_ACCT_TYPE_CD              = S.NATL_ACCT_TYPE
,FIRST_BILL_IND                 = S.FIRST_BILL
,IVR_ACCT_VALUE_IND             = S.IVR_VALUE
,PORT_IN_IND                    = S.PORT_IN
,PROMPT_SELECTED_CD             = S.PROMPT_SELECTED
,PAID_AMT                       = S.AMOUNT_PAID
,BILL_METHOD_CD                 = S.PAYMENT_METHOD
,ROUTE_CD                       = S.ROUTE_VALUE
,CALL_PATH                      = S.CALLPATH
,CACS_STATE_CD                  = S.CACS_STATE
,ROUTE_ID                       = S.ROUTE_ID
,ESN_NUM_PREV                   = S.ESNMEID_ORIG
,ESN_NUM                        = S.ESNMEID_NEW
,PREPAID_PPLAN_CD               = S.PREPAY_COSP
,PREPAID_STATUS_CD              = S.PREPAY_STATUS
,REVISED_ROLE_CD                = S.REVISED_ROLE
,SELFHELPSTART                  = S.SELFHELPSTART
,ONEBILL_IND                    = S.ONEBILL_FLAG
,DEVICE_ID                      = S.DEVICE_ID
,USR_ORIG_DN                    = S.USR_ORIG_DN
,SLS_DIST_CHNL_GRP_CD           = S.SALES_CHANNEL
,EMP_ID                         = S.EMP_ID
,ESC_LOC_CD                     = S.ESC_LOC_CD
,CMR_FLAG                       = S.CMR_FLAG
,INBOUND_CALL_TYPE              = S.INBOUND_CALL_TYPE
,DEV_TYPE_PREV                  = S.DEV_TYPE_ORG
,DEV_TYPE_NEW                   = S.DEV_TYPE_NEW
,KPI_SELFHELP_RULE              = S.KPI_SELFHELP_RULE
,KPI_SELFHELPSTART_RULE         = S.KPI_SELFHELPSTART_RULE
,IMEI_ORIG                      = S.IMEI_ORIG
,IMEI_NEW                       = S.IMEI_NEW  
,NOTIFICATION_ID                = S.NOTIFICATION_ID
,CBR_NUMBER                     = S.CBR_NUMBER
,ERR_MSG                        = S.ERR_MSG
,US_TYPE_PROD_ID  				= S.US_TYPE_PROD_ID
,US_LOB 						= S.US_LOB
,LAST_UPD_DT                    = DATE
,ROUTE_SELECT_VALUE             = S.ROUTE_SELECT_VALUE
,LOB                            = S.LOB
,C2C_EMPLOYEE_ID                = s.C2C_EMPLOYEE_ID
 
WHEN NOT MATCHED
THEN INSERT
VALUES (
IVR_CALL_ID                    = S.PCID
,SOR_ID                         = S.SOR_ID
,CUST_ID                        = S.CUST_ID
,CUST_LINE_SEQ_ID               = S.CUST_LINE_SEQ_ID
,CPS_ID                         = S.CPS
,IVR_LINE_ID                    = S.LINE
,IVR_CALL_SOU                   = S.DURATION
,IVR_STEPS                      = S.STEPS
,LANG_PREF_IND                  = S.LANG_PREF_IND
,DNIS_CD                        = S.DNIS
,ANI_NUM                        = S.ANI
,AD_CD                          = S.ADFLAG
,ANI_INSTANCE_IND               = S.ANIFLAG
,IVR_FINAL_RESULT               = S.FINALRESULT
,INIT_TYPE_CD                   = S.INITTYPE
,IVR_CALL_DT                    = S.CALLDATE
,IVR_CALL_TM                    = S.CALLTIME
,RGSTR_GEOTEL_IND               = S.REGISTERED
,TRANSFER_POINT                 = S.TPOINT
,SELFHELP                       = S.SELFHELP
,MTN                            = S.LASTMTN
,PREPAID_IND                    = S.PREPAID
,NPA_NUM                        = S.NPA
,BSC                            = S.BSC   
,COAST_IND                      = S.JIC1
,FINAL_CACS_VALUE               = S.CACS
,NATL_ACCT_TYPE_CD              = S.NATL_ACCT_TYPE
,FIRST_BILL_IND                 = S.FIRST_BILL
,IVR_ACCT_VALUE_IND             = S.IVR_VALUE
,PORT_IN_IND                    = S.PORT_IN
,PROMPT_SELECTED_CD             = S.PROMPT_SELECTED
,PAID_AMT                       = S.AMOUNT_PAID
,BILL_METHOD_CD                 = S.PAYMENT_METHOD
,ROUTE_CD                       = S.ROUTE_VALUE
,CALL_PATH                      = S.CALLPATH
,CACS_STATE_CD                  = S.CACS_STATE
,ROUTE_ID                       = S.ROUTE_ID
,ESN_NUM_PREV                   = S.ESNMEID_ORIG
,ESN_NUM                        = S.ESNMEID_NEW
,PREPAID_PPLAN_CD               = S.PREPAY_COSP
,PREPAID_STATUS_CD              = S.PREPAY_STATUS
,REVISED_ROLE_CD                = S.REVISED_ROLE
,SELFHELPSTART                  = S.SELFHELPSTART
,ONEBILL_IND                    = S.ONEBILL_FLAG
,DEVICE_ID                      = S.DEVICE_ID
,USR_ORIG_DN                    = S.USR_ORIG_DN
,SLS_DIST_CHNL_GRP_CD           = S.SALES_CHANNEL
,EMP_ID                         = S.EMP_ID
,ESC_LOC_CD                     = S.ESC_LOC_CD
,CMR_FLAG                       = S.CMR_FLAG
,INBOUND_CALL_TYPE              = S.INBOUND_CALL_TYPE
,DEV_TYPE_PREV                  = S.DEV_TYPE_ORG
,DEV_TYPE_NEW                   = S.DEV_TYPE_NEW
,KPI_SELFHELP_RULE              = S.KPI_SELFHELP_RULE
,KPI_SELFHELPSTART_RULE         = S.KPI_SELFHELPSTART_RULE
,IMEI_ORIG                      = S.IMEI_ORIG
,IMEI_NEW                       = S.IMEI_NEW  
,NOTIFICATION_ID                = S.NOTIFICATION_ID
,CBR_NUMBER                     = S.CBR_NUMBER  
,ERR_MSG                        = S.ERR_MSG
,US_TYPE_PROD_ID  				= S.US_TYPE_PROD_ID
,US_LOB 						= S.US_LOB
,INSERT_DT                      = DATE
,LAST_UPD_DT                    = DATE
,ROUTE_SELECT_VALUE             = S.ROUTE_SELECT_VALUE
,LOB                            = S.LOB
,C2C_EMPLOYEE_ID                = S.C2C_EMPLOYEE_ID
);
